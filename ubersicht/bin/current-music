#!/bin/bash

mpc_playing=$(/usr/local/bin/mpc status | grep 'playing')
itunes_playing=$(osascript -e '
	if application "iTunes" is running then
		tell app "iTunes" to return player state is playing
	else
		return false
	end if
')

if [[ $mpc_playing ]]; then
    echo $(/usr/local/bin/mpc current -f "%artist% - %title%")
elif [[ $itunes_playing == 'true' ]]; then
    artist=$(osascript -e 'tell app "iTunes" to return artist of current track' 2>/dev/null)
    artist_exit=$?
    title=$(osascript -e 'tell app "iTunes" to return name of current track' 2>/dev/null)
    title_exit=$?
    # Current, but maybe not latest, versions of iTunes have broken AppleScript support when playing Apple Music tracks, so handle that gracefully
    if [[ $artist_exit != 0 || $title_exit != 0 ]]; then
        echo "Apple Music"
    else
        echo "$artist - $title"
    fi
fi
